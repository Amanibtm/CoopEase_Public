{% load static %}
<html lang="en">
<head>

    <!-- Bootstrap CSS -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'bootstrap_datepicker_plus/css/bootstrap-datepicker3.min.css' %}">
    <script src="{% static 'bootstrap_datepicker_plus/js/bootstrap-datepicker.min.js' %}"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">


    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
</head>
<body>
    {% include 'navbar.html' %}
    <!-- Global Alert Container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div id="global-alert-container"></div>
    </div>

    {% block content %}{% endblock %}

    <!-- Bootstrap JS Bundle + Custom JS -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

    <!-- Notification System JS -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Django messages (non-AJAX)
        const handleDjangoMessages = () => {
            const alerts = document.querySelectorAll('.alert:not(.global-alert)');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 300);
                }, 10000);
            });
        };

        // Universal alert display function
        const showAlert = (type, message, source=null) => {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show global-alert`;
            alertDiv.setAttribute('data-source', source || 'global');
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            document.getElementById('global-alert-container').appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        };


        // prevent user from go back in navigation history after the logout
        {% if not user.is_authenticated %}

            if (window.history.replaceState) {
                window.history.replaceState(null, '', window.location.href);
            }
            window.onload = function () {
                if (performance.getEntriesByType("navigation")[0].type === "back_forward") {
                    window.location.href = "{% url 'login' %}";
                }
            };
        {% endif %}

        // Enhanced form handling
        const handleFormSubmit = async (form) => {
            // Get all required inputs from the form row
            const formRow = form.closest('tr');
            const moduleSelect = formRow?.querySelector('.module-select');
            const moduleTypeSelect = formRow?.querySelector('.TM-select');
            const groupInput = formRow?.querySelector('.group');
            const sectionInput = formRow?.querySelector('.section');

            // Validate required fields
            if (moduleSelect && !moduleSelect.value) {
                showAlert('error', 'Veuillez sélectionner un module', form.dataset.pageIdentifier);
                return;
            }
            if (moduleTypeSelect && !moduleTypeSelect.value) {
                showAlert('error', 'Veuillez sélectionner un type de module', form.dataset.pageIdentifier);
                return;
            }
            if (groupInput && !groupInput.value) {
                showAlert('error', 'Veuillez entrer un groupe', form.dataset.pageIdentifier);
                return;
            }
            if (sectionInput && !sectionInput.value) {
                showAlert('error', 'Veuillez entrer un section', form.dataset.pageIdentifier);
                return;
            }

            // Set hidden input values if they exist
            const moduleInput = form.querySelector('.module-input');
            const moduleTypeInput = form.querySelector('.module-type-input');
            const groupHiddenInput = form.querySelector('.group-input');
            const sectionHiddenInput = form.querySelector('.section-input');

            if (moduleInput && moduleSelect) moduleInput.value = moduleSelect.value;
            if (moduleTypeInput && moduleTypeSelect) moduleTypeInput.value = moduleTypeSelect.value;
            if (groupHiddenInput && groupInput) groupHiddenInput.value = groupInput.value;
            if (sectionHiddenInput && sectionInput) sectionHiddenInput.value = sectionInput.value;

            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const originalContent = submitButton?.innerHTML;
            const pageSource = form.dataset.pageIdentifier || 'global';

            try {
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = `
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        ${submitButton.textContent.trim()}
                    `;
                }

                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.message) {
                    showAlert(data.status || 'success', data.message, pageSource);
                }

                if (data.redirect) {
                    window.location.href = data.redirect;
                }

                // Refresh the page after successful reservation for both booking types
                if (data.status === 'success' && (pageSource === 'book_space' || pageSource === 'book_occasional')) {
                    setTimeout(() => window.location.reload(), 1500);
                }

            } catch (error) {
                showAlert('error', 'Une erreur est survenue: ' + error.message, pageSource);
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalContent;
                }
            }
        };

        // Initialize
        handleDjangoMessages();

        // Auto-attach to forms with data-ajax-form attribute
        document.querySelectorAll('form[data-ajax-form]').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                handleFormSubmit(this);
            });
        });

        // Make showAlert available globally for other scripts
        window.showAlert = showAlert;
    });
    </script>

    <!-- Your existing custom JS -->
    <script src="{% static 'js/scripts.js' %}"></script>
</body>
</html>